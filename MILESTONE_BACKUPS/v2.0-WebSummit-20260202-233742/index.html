<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure CloudOps Intelligence Agent - Enterprise Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #0f0f23;
            --surface: #1a1a2e;
            --surface-light: #25254d;
            --surface-hover: #2d2d55;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c8;
            --text-muted: #6b6b8f;
            --border: #2a2a4a;
            --shadow-sm: 0 2px 8px rgba(99, 102, 241, 0.1);
            --shadow-md: 0 4px 16px rgba(99, 102, 241, 0.15);
            --shadow-lg: 0 8px 32px rgba(99, 102, 241, 0.2);
            --shadow-xl: 0 16px 64px rgba(99, 102, 241, 0.25);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .brand:hover {
            transform: translateX(2px);
        }

        .logo {
            width: 108px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .logo img {
            width: 100%;
            height: auto;
        }

        .subscription-selector {
            display: flex;
            align-items: center;
            margin-right: 24px;
        }

        .subscription-selector select {
            background: var(--surface-light);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
        }

        .subscription-selector select:hover {
            border-color: var(--primary);
        }

        .subscription-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .brand-text h1 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .brand-text p {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .header-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .header-stat-icon {
            font-size: 20px;
        }

        .header-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .header-stat.success .header-stat-value {
            color: var(--success);
        }

        .header-stat.warning .header-stat-value {
            color: var(--warning);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-profile:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            box-shadow: var(--shadow-sm);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .logout-btn {
            padding: 10px 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--surface-light);
            border-radius: 3px;
        }

        .sidebar-section {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Insight Cards */
        .insight-card {
            background: linear-gradient(135deg, var(--surface-light) 0%, var(--surface-hover) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .insight-card.success::before {
            background: var(--success);
        }

        .insight-card.warning::before {
            background: var(--warning);
        }

        .insight-card.danger::before {
            background: var(--danger);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .insight-icon {
            font-size: 24px;
        }

        .insight-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .insight-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .insight-card.success .insight-value {
            color: var(--success);
        }

        .insight-card.warning .insight-value {
            color: var(--warning);
        }

        .insight-card.danger .insight-value {
            color: var(--danger);
        }

        .insight-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .insight-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Category Section */
        .category-section {
            margin-bottom: 8px;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .category-header:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
        }

        .category-header.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .category-header.active .category-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-toggle {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .category-header.active .category-toggle {
            transform: rotate(180deg);
        }

        .category-prompts {
            display: none;
            padding: 8px 0;
        }

        .category-prompts.active {
            display: block;
        }

        .prompt-item {
            padding: 12px 16px;
            margin: 4px 0;
            background: var(--surface-light);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt-item:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .prompt-icon {
            font-size: 16px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #0f0f23 100%);
            position: relative;
        }

        .chat-messages::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--surface-light);
            border-radius: 4px;
        }

        /* Welcome State */
        .welcome-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 48px;
            position: relative;
            z-index: 1;
        }

        .welcome-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #0078D4 0%, #005A9E 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            box-shadow: var(--shadow-xl);
            animation: float 3s ease-in-out infinite;
            padding: 28px;
        }

        .welcome-icon svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .welcome-state h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-state p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 48px;
            max-width: 600px;
        }

        .welcome-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }

        .welcome-category-card {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .welcome-category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .welcome-category-card:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .welcome-category-card:hover::before {
            transform: scaleX(1);
        }

        .welcome-category-icon {
            font-size: 36px;
            margin-bottom: 16px;
            display: block;
        }

        .welcome-category-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .welcome-category-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .welcome-category-count {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--gradient-primary);
            box-shadow: var(--shadow-sm);
        }

        .message.assistant .message-avatar {
            background: var(--surface-light);
            border: 2px solid var(--border);
        }

        .message-content {
            flex: 1;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 20px;
            color: var(--text-primary);
            line-height: 1.6;
            max-width: 85%;
        }

        .message.user .message-content {
            background: var(--gradient-primary);
            border: none;
            box-shadow: var(--shadow-sm);
        }

        /* Table Styling for Assistant Responses */
        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: var(--surface);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .message-content thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .message-content th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
        }

        .message-content td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .message-content tbody tr {
            transition: all 0.2s;
        }

        .message-content tbody tr:hover {
            background: var(--surface-hover);
        }

        .message-content tbody tr:last-child td {
            border-bottom: none;
        }

        .message-content .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
            margin: 16px 0;
            border-radius: 8px;
            border: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }

        /* Scrollbar styling for tables */
        .message-content .table-wrapper::-webkit-scrollbar {
            height: 10px;
        }

        .message-content .table-wrapper::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 5px;
        }

        .message-content .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        .message-content .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Ensure tables are wide enough to scroll */
        .message-content table {
            min-width: 800px;
            width: 100%;
        }

        .message-content strong {
            color: var(--primary);
            font-weight: 600;
        }

        .message-content .cost-highlight {
            color: var(--warning);
            font-weight: 700;
        }

        .message-content .savings-highlight {
            color: var(--success);
            font-weight: 700;
        }

        .message-content .danger-highlight {
            color: var(--danger);
            font-weight: 700;
        }

        /* Input Area */
        .input-area {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 24px 32px;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }

        #userInput {
            flex: 1;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            min-height: 80px;
            max-height: 200px;
            transition: all 0.3s;
            line-height: 1.6;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        #userInput::placeholder {
            color: var(--text-muted);
        }

        #sendBtn {
            padding: 14px 32px;
            background: var(--gradient-accent);
            border: none;
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #sendBtn:active {
            transform: translateY(0);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .header-stats {
                display: none;
            }

            .welcome-categories {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .header {
                padding: 0 20px;
            }

            .chat-messages {
                padding: 20px;
            }

            .input-area {
                padding: 16px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="brand" onclick="goHome()">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 609 130" style="width: 108px; height: 24px;">
                    <path fill="#f25022" d="M0 0h61.3v61.3H0z"/>
                    <path fill="#7fba00" d="M67.7 0H129v61.3H67.7z"/>
                    <path fill="#00a4ef" d="M0 67.7h61.3V129H0z"/>
                    <path fill="#ffb900" d="M67.7 67.7H129V129H67.7z"/>
                    <text x="145" y="95" font-family="Segoe UI, Arial, sans-serif" font-size="72" font-weight="600" fill="#5E5E5E">Microsoft</text>
                </svg>
            </div>
            <div class="brand-text">
                <h1>Azure CloudOps Intelligence Agent</h1>
                <p>Enterprise Edition</p>
            </div>
        </div>
        
        <div class="subscription-selector">
            <label for="subscriptionSelect" style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-right: 8px;">Subscription:</label>
            <select id="subscriptionSelect" onchange="changeSubscription()">
                <option value="all">All Subscriptions</option>
                <option value="loading" selected>Loading subscriptions...</option>
            </select>
        </div>

        <div class="header-stats">
            <div class="header-stat success">
                <div>
                    <div class="header-stat-value">92%</div>
                    <div class="header-stat-label">Health Score</div>
                </div>
                <div class="header-stat-icon">üíö</div>
            </div>
            <div class="header-stat warning">
                <div>
                    <div class="header-stat-value">$2,450</div>
                    <div class="header-stat-label">Monthly Cost</div>
                </div>
                <div class="header-stat-icon">üí∞</div>
            </div>
            <div class="header-stat">
                <div>
                    <div class="header-stat-value">87</div>
                    <div class="header-stat-label">Resources</div>
                </div>
                <div class="header-stat-icon">üì¶</div>
            </div>
        </div>

        <div class="header-actions">
            <div class="user-profile" id="userProfile" style="display: none;">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <span class="user-name" id="userName">Loading...</span>
                    <span class="user-email" id="userEmail"></span>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Insights Section -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span>üìä</span> Azure Insights
                </h3>
                
                <div class="insight-card success">
                    <div class="insight-header">
                        <div class="insight-icon">üõ°Ô∏è</div>
                        <div class="insight-title">Security Score</div>
                    </div>
                    <div class="insight-value">85/100</div>
                    <div class="insight-subtitle">Excellent security posture</div>
                    <div class="insight-footer">
                        ‚úì 3 recommendations applied this week
                    </div>
                </div>

                <div class="insight-card warning">
                    <div class="insight-header">
                        <div class="insight-icon">üí°</div>
                        <div class="insight-title">Cost Optimization</div>
                    </div>
                    <div class="insight-value">$890</div>
                    <div class="insight-subtitle">Potential monthly savings</div>
                    <div class="insight-footer">
                        ‚ö†Ô∏è 5 underutilized resources detected
                    </div>
                </div>

                <div class="insight-card success">
                    <div class="insight-header">
                        <div class="insight-icon">‚ö°</div>
                        <div class="insight-title">Performance</div>
                    </div>
                    <div class="insight-value">98.7%</div>
                    <div class="insight-subtitle">Average uptime (30 days)</div>
                    <div class="insight-footer">
                        ‚úì All systems operational
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span>üéØ</span> Quick Actions
                </h3>

                <!-- Resource Management Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('resources')">
                        <div class="category-info">
                            <div class="category-icon">üì¶</div>
                            <div class="category-name">Resource Management</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-resources">
                        <div class="prompt-item" onclick="quickPrompt('I want to list Azure resources. Please present these filtering options with numbered choices: 1) All resources in subscription, 2) Filter by specific subscription (ask which), 3) Filter by resource type (ask which type), 4) Filter by location/region (ask which), 5) Filter by resource group (ask which), 6) Filter by tag (ask which tag). Wait for my selection before showing results.')">
                            <span class="prompt-icon">üìã</span>
                            <span>List resources with filters</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to search for specific resources. Ask me what to search for (resource name, type, or tag name), then show matching resources in a table with: Resource Name, Type, Region, Resource Group, Tags, Status.')">
                            <span class="prompt-icon">üîç</span>
                            <span>Search resources</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Check resource health for ALL resources in my current subscription. Show table with: Resource Name, Type, Health Status, Availability %, Issues, Last Health Event, Recommendations.')">
                            <span class="prompt-icon">üíö</span>
                            <span>Check resource health</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to create a new resource. Ask me: 1) What type (VM/Storage/Database/Web App)? 2) Resource group name? 3) Region? Then guide me through deployment.')">
                            <span class="prompt-icon">‚ûï</span>
                            <span>Create resource</span>
                        </div>
                    </div>
                </div>

                <!-- Cost Optimization Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('cost')">
                        <div class="category-info">
                            <div class="category-icon">üí∞</div>
                            <div class="category-name">Cost Optimization</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-cost">
                        <div class="prompt-item" onclick="quickPrompt('I want to analyze costs for my Azure resources. Present these filtering options: 1) All resources with costs in current subscription, 2) Filter by specific subscription, 3) Filter by resource type (VMs, Storage, SQL, etc.), 4) Filter by resource group, 5) Filter by tag (CostCenter, Environment, Department), 6) Filter by location/region. Wait for my selection before showing ACTUAL resource names and costs.')">
                            <span class="prompt-icon">üìä</span>
                            <span>Cost breakdown with filters</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Analyze my current subscription for cost savings opportunities. Show ACTUAL resource names (not fake examples) with: Resource Name, Type, Current Monthly Cost, Utilization %, Recommended Action, Potential Monthly Savings, Annual Savings, Implementation Effort. Focus on deallocated VMs, orphaned disks, unattached IPs, and rightsizing opportunities. Calculate total potential savings.')">
                            <span class="prompt-icon">üîç</span>
                            <span>Find savings opportunities</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to see costs filtered by business unit or tag. Ask me which tag to filter by (CostCenter, Environment, Department, Project, Owner) and optionally the tag value, then show ACTUAL resources with cost estimates grouped by that tag.')">
                            <span class="prompt-icon">üè∑Ô∏è</span>
                            <span>Costs by tag/business unit</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Compare costs across different filters. Present options: 1) By resource group, 2) By resource type, 3) By location, 4) By tag. Wait for selection, then show ACTUAL resources with costs, current month vs last month comparison.')">
                            <span class="prompt-icon">üìà</span>
                            <span>Cost comparison with filters</span>
                        </div>
                    </div>
                </div>

                <!-- Security & Compliance Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('security')">
                        <div class="category-info">
                            <div class="category-icon">üîí</div>
                            <div class="category-name">Security & Compliance</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-security">
                        <div class="prompt-item" onclick="quickPrompt('Run comprehensive security assessment on all Azure resources. Provide a table with: Resource Name, Type, Security Score, Severity (Critical/High/Medium/Low), Issue Description, Recommended Remediation, Compliance Impact, Estimated Fix Time. Focus on: unencrypted storage, public endpoints, weak authentication, missing MFA, outdated TLS, excessive permissions, unpatched systems. Prioritize by severity. Include overall security score and critical findings count.')">
                            <span class="prompt-icon">üõ°Ô∏è</span>
                            <span>Security assessment</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show detailed compliance status across all frameworks. Create a table with: Compliance Framework (ISO 27001, SOC 2, HIPAA, PCI-DSS, GDPR), Compliance Score %, Passed Controls, Failed Controls, Critical Gaps, Remediation Priority, Estimated Cost to Comply. Highlight non-compliant areas and provide actionable recommendations.')">
                            <span class="prompt-icon">‚úÖ</span>
                            <span>Compliance check</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Review all Network Security Groups and provide security analysis table with: NSG Name, Associated Resource, Total Rules, Inbound Rules, Outbound Rules, Risky Rules (Any/Any, 0.0.0.0/0), Open Ports, Security Risk Level, Recommendations. Flag rules allowing traffic from internet on sensitive ports (RDP 3389, SSH 22, SQL 1433).')">
                            <span class="prompt-icon">üåê</span>
                            <span>NSG configuration</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Identify all resources with public internet exposure. Provide table with: Resource Name, Type, Public IP/Endpoint, Exposed Ports, Access Level, Risk Level (Critical/High/Medium), Data Classification, Recommendation, Mitigation Steps. Include: storage accounts with public access, VMs with public IPs, databases without firewall rules, Key Vaults with public access. Calculate total exposure count.')">
                            <span class="prompt-icon">‚ö†Ô∏è</span>
                            <span>Public exposure check</span>
                        </div>
                    </div>
                </div>

                <!-- Monitoring & Alerts Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('monitoring')">
                        <div class="category-info">
                            <div class="category-icon">üìà</div>
                            <div class="category-name">Monitoring & Alerts</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-monitoring">
                        <div class="prompt-item" onclick="quickPrompt('Check performance metrics for ALL VMs in my current subscription for the last 24 hours. Show table with: Resource Name, Type, CPU %, Memory %, Disk IOPS, Network Throughput, Response Time, Availability %, Health Status, Performance Grade. Highlight resources with CPU > 80% or issues.')">
                            <span class="prompt-icon">‚ö°</span>
                            <span>Performance metrics</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL active alerts in my current subscription. Provide table: Alert Name, Resource, Severity, Triggered Time, Duration, Current Value, Threshold, Impact Level, Recommended Action. Group by severity (Critical first) and show alert trends.')">
                            <span class="prompt-icon">üîî</span>
                            <span>Active alerts</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to create an alert rule. Ask me: 1) Which resource to monitor? 2) Alert condition (CPU/Memory/Disk/Network)? 3) Threshold value? 4) Email for notifications? Then configure the alert.')">
                            <span class="prompt-icon">üìä</span>
                            <span>Create alert rule</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show Application Insights data for ALL applications in my current subscription for the last 24 hours. Provide table: Application Name, Requests/min, Avg Response Time, Failed Request %, Exception Count, Dependency Calls, Availability %, Slowest Operations, Top Errors.')">
                            <span class="prompt-icon">üìù</span>
                            <span>Application insights</span>
                        </div>
                    </div>
                </div>

                <!-- Tags Management Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('tags')">
                        <div class="category-info">
                            <div class="category-icon">üè∑Ô∏è</div>
                            <div class="category-name">Tags Management</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-tags">
                        <div class="prompt-item" onclick="quickPrompt('Find ALL resources missing critical tags (Environment, CostCenter, Owner) in my current subscription. Show table: Resource Name, Type, Resource Group, Region, Current Tags, Missing Tags, Compliance Status, Recommendation.')">
                            <span class="prompt-icon">‚ö†Ô∏è</span>
                            <span>Resources missing tags</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me complete tag inventory for my current subscription. Provide table with: Tag Name, Unique Values Count, Total Resources Using This Tag, Most Common Value, Resource Types, Usage Percentage, Recommendations.')">
                            <span class="prompt-icon">üìä</span>
                            <span>Tag inventory & usage</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Analyze tag compliance for my current subscription. Check for required tags: Environment, CostCenter, Owner. Provide table: Resource Name, Type, Environment Tag, CostCenter Tag, Owner Tag, Compliance Score %, Issue Severity, Remediation Steps.')">
                            <span class="prompt-icon">‚úÖ</span>
                            <span>Tag compliance check</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to search by a specific tag. Ask me: 1) Tag name? 2) Tag value (optional)? Then show table with: Resource Name, Type, Region, Resource Group, All Tags, Status.')">
                            <span class="prompt-icon">üîç</span>
                            <span>Search by tag</span>
                        </div>
                    </div>
                </div>

                <!-- Azure Policy Compliance Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('policy')">
                        <div class="category-info">
                            <div class="category-icon">üìú</div>
                            <div class="category-name">Azure Policy & Governance</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-policy">
                        <div class="prompt-item" onclick="quickPrompt('Show me Azure Policy compliance status for my current subscription. Provide table: Policy Name, Compliance State, Compliant Resources, Non-Compliant Resources, Compliance %, Severity, Remediation Required. Sort by non-compliant count.')">
                            <span class="prompt-icon">üìä</span>
                            <span>Policy compliance dashboard</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Identify ALL non-compliant resources in my current subscription with severity level ALL. Show: Resource Name, Type, Non-Compliant Policies, Severity, Impact, Automated Remediation Available, Manual Steps Required, Estimated Fix Time.')">
                            <span class="prompt-icon">‚ö†Ô∏è</span>
                            <span>Non-compliant resources</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Recommend high-impact Azure Policies for my current subscription focusing on ALL areas (Cost, Security, Operations, Compliance). Provide table: Policy Name, Category, Impact Level, Benefits, Implementation Effort, Expected ROI, Enforcement Mode Recommendation.')">
                            <span class="prompt-icon">üí°</span>
                            <span>Policy recommendations</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Analyze ALL policy exemptions in my current subscription including expired ones. Show table: Resource, Exempted Policy, Exemption Reason, Requested By, Expiration Date, Risk Level, Review Recommendation. Highlight expired exemptions.')">
                            <span class="prompt-icon">üö´</span>
                            <span>Policy exemptions audit</span>
                        </div>
                    </div>
                </div>

                <!-- Update Management Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('updates')">
                        <div class="category-info">
                            <div class="category-icon">üîÑ</div>
                            <div class="category-name">Update Management</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-updates">
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure VMs (IaaS) in my current subscription with pending updates. Provide table: VM Name, Resource Group, OS Type, OS Version, Pending Critical Updates, Pending Security Updates, Pending Other Updates, Total Pending, Last Assessment Time, Compliance Status. Sort by critical updates first.')">
                            <span class="prompt-icon">üíª</span>
                            <span>VM pending updates</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure Arc-enabled servers in my current subscription with pending updates. Provide table: Server Name, Resource Group, OS Type, OS Version, Pending Critical Updates, Pending Security Updates, Pending Other Updates, Total Pending, Last Assessment Time, Location, Compliance Status. Sort by critical updates first.')">
                            <span class="prompt-icon">üåê</span>
                            <span>Arc servers pending updates</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure VMs in my current subscription that require reboot. Provide table: VM Name, Resource Group, OS Type, Power State, Reboot Required Reason, Pending Updates Requiring Reboot, Last Boot Time, Uptime Days, Priority Level. Highlight VMs with critical updates pending reboot.')">
                            <span class="prompt-icon">üîÑ</span>
                            <span>VMs pending reboot</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure Arc-enabled servers in my current subscription that require reboot. Provide table: Server Name, Resource Group, OS Type, Status, Reboot Required Reason, Pending Updates Requiring Reboot, Last Boot Time, Uptime Days, Priority Level. Highlight servers with critical security updates.')">
                            <span class="prompt-icon">üîÅ</span>
                            <span>Arc servers pending reboot</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me update compliance summary for my current subscription across ALL machines (both Azure VMs and Arc servers). Provide summary table: Machine Type, Total Count, Fully Updated, Pending Critical, Pending Security, Pending Other, Reboot Required, Non-Compliant %, Oldest Assessment. Include overall compliance score.')">
                            <span class="prompt-icon">üìä</span>
                            <span>Update compliance summary</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me machines with FAILED update installations in my current subscription (both Azure VMs and Arc servers). Provide table: Machine Name, Type, Resource Group, Failed Update Name, Failure Reason, Attempted Date, Retry Count, Recommended Action, Impact Level. Include troubleshooting guidance.')">
                            <span class="prompt-icon">‚ùå</span>
                            <span>Failed update installations</span>
                        </div>
                    </div>
                </div>

                <!-- Azure Arc / Hybrid Management Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('arc')">
                        <div class="category-info">
                            <div class="category-icon">üåê</div>
                            <div class="category-name">Azure Arc Management</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-arc">
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure Arc-enabled machines in my current subscription. Provide table: Machine Name, Resource Group, Subscription, OS Type, OS Version, Agent Status, Agent Version, Defender Status, Monitoring Status, Pending Updates, Last Status Change, Location, Compliance Status. Sort by compliance status.')">
                            <span class="prompt-icon">üíª</span>
                            <span>Arc-enabled machines</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure Arc-enabled SQL Servers in my current subscription. Provide table: SQL Server Name, Resource Group, SQL Version, Edition, Location, Database Count, Status, Patch Level, License Type, Last Inventory Upload, Compliance Status. Sort by SQL Server name.')">
                            <span class="prompt-icon">üóÑÔ∏è</span>
                            <span>Arc-enabled SQL Servers</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Show me ALL Azure Arc machines with agent not reporting or disconnected in my current subscription. Provide table: Machine Name, Resource Group, OS Type, Agent Status, Agent Version, Last Status Change, Days Since Last Report, Location, Issue Level, Recommended Action. Sort by days since last report descending.')">
                            <span class="prompt-icon">‚ö†Ô∏è</span>
                            <span>Arc agents not reporting</span>
                        </div>
                    </div>
                </div>

                <!-- AI & Automation Category -->
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('automation')">
                        <div class="category-info">
                            <div class="category-icon">ü§ñ</div>
                            <div class="category-name">AI & Automation</div>
                        </div>
                        <div class="category-toggle">‚ñº</div>
                    </div>
                    <div class="category-prompts" id="category-automation">
                        <div class="prompt-item" onclick="quickPrompt('Analyze my current subscription for automation opportunities focusing on ALL areas (Deployment, Backup, Scaling, Patching, Monitoring). Provide table: Task/Process, Current Method, Frequency, Time Spent per Week, Automation Tool Recommendation (Azure Automation/Logic Apps/Functions), Implementation Steps, Time Savings, Cost Savings, ROI %.')">
                            <span class="prompt-icon">üí°</span>
                            <span>Automation suggestions</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to set up auto-scaling. Ask me: 1) Which resource (VM Scale Set/App Service/AKS)? 2) Resource group? 3) Scaling metric (CPU/Memory/Requests)? 4) Min/Max instances? Then configure auto-scaling rules.')">
                            <span class="prompt-icon">üìà</span>
                            <span>Auto-scaling rules</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('I want to generate Infrastructure as Code. Ask me: 1) Template type (ARM/Bicep/Terraform)? 2) Which resources to include? 3) Export existing or create new? Then generate the template with best practices.')">
                            <span class="prompt-icon">üìÑ</span>
                            <span>Generate IaC template</span>
                        </div>
                        <div class="prompt-item" onclick="quickPrompt('Analyze ALL resources in my current subscription for the last 30 days using AI-driven optimization. Show table: Resource Name, Current SKU, Usage Pattern Analysis, AI-Recommended SKU, Performance Impact, Cost Impact $/month, Confidence %, Risk Level, Implementation Priority. Include total potential savings.')">
                            <span class="prompt-icon">üéØ</span>
                            <span>AI optimization</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-messages" id="chatContainer">
                <div class="welcome-state">
                    <div class="welcome-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 23 23">
                            <rect width="11" height="11" fill="#F25022"/>
                            <rect x="12" width="11" height="11" fill="#7FBA00"/>
                            <rect y="12" width="11" height="11" fill="#00A4EF"/>
                            <rect x="12" y="12" width="11" height="11" fill="#FFB900"/>
                        </svg>
                    </div>
                    <h2>Welcome to Azure CloudOps Intelligence Agent</h2>
                    <p>Your intelligent assistant for comprehensive Azure infrastructure management including Resource Management, Cost Optimization, Security & Compliance, Monitoring & Alerts, Tags Management, Azure Policy & Governance, Update Management, Azure Arc & Hybrid Management, and AI & Automation. Select a category to get started.</p>
                    
                    <div class="welcome-categories">
                        <div class="welcome-category-card" onclick="showCategory('resources')">
                            <span class="welcome-category-icon">üì¶</span>
                            <div class="welcome-category-title">Resource Management</div>
                            <div class="welcome-category-desc">Deploy, manage, and monitor your Azure resources efficiently</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('cost')">
                            <span class="welcome-category-icon">üí∞</span>
                            <div class="welcome-category-title">Cost Optimization</div>
                            <div class="welcome-category-desc">Identify savings and optimize your Azure spending</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('security')">
                            <span class="welcome-category-icon">üîí</span>
                            <div class="welcome-category-title">Security & Compliance</div>
                            <div class="welcome-category-desc">Ensure security best practices and compliance</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('monitoring')">
                            <span class="welcome-category-icon">üìà</span>
                            <div class="welcome-category-title">Monitoring & Alerts</div>
                            <div class="welcome-category-desc">Track performance and configure intelligent alerts</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('automation')">
                            <span class="welcome-category-icon">ü§ñ</span>
                            <div class="welcome-category-title">AI & Automation</div>
                            <div class="welcome-category-desc">Leverage AI for intelligent infrastructure automation</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('updates')">
                            <span class="welcome-category-icon">üîÑ</span>
                            <div class="welcome-category-title">Update Management</div>
                            <div class="welcome-category-desc">Track patches, updates, and reboot status for VMs and Arc servers</div>
                            <div class="welcome-category-count">6 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('arc')">
                            <span class="welcome-category-icon">üåê</span>
                            <div class="welcome-category-title">Azure Arc Management</div>
                            <div class="welcome-category-desc">Monitor hybrid infrastructure with Arc-enabled machines and SQL servers</div>
                            <div class="welcome-category-count">3 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('tags')">
                            <span class="welcome-category-icon">üè∑Ô∏è</span>
                            <div class="welcome-category-title">Tags Management</div>
                            <div class="welcome-category-desc">Governance, compliance, and tag-based organization</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="showCategory('policy')">
                            <span class="welcome-category-icon">üìú</span>
                            <div class="welcome-category-title">Azure Policy & Governance</div>
                            <div class="welcome-category-desc">Policy compliance and governance insights</div>
                            <div class="welcome-category-count">4 Quick Actions</div>
                        </div>
                        
                        <div class="welcome-category-card" onclick="quickPrompt('What are the latest Azure best practices for my infrastructure?')">
                            <span class="welcome-category-icon">üí°</span>
                            <div class="welcome-category-title">Best Practices</div>
                            <div class="welcome-category-desc">Get personalized recommendations and insights</div>
                            <div class="welcome-category-count">Ask me anything</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="userInput" placeholder="Ask me anything about Azure infrastructure, costs, security, or optimization..." rows="1"></textarea>
                    <button id="sendBtn" onclick="sendMessage()">Send ‚úàÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];

        // Load user profile
        function loadUserProfile() {
            console.log('üîç Loading user profile...');
            
            let userInfo = sessionStorage.getItem('userInfo');
            if (!userInfo) {
                userInfo = localStorage.getItem('userInfo');
                if (userInfo) {
                    sessionStorage.setItem('userInfo', userInfo);
                }
            }
            
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    document.getElementById('userProfile').style.display = 'flex';
                    document.getElementById('userName').textContent = user.name || 'User';
                    document.getElementById('userEmail').textContent = user.email || '';
                    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'U';
                    document.getElementById('userAvatar').textContent = initials;
                } catch (error) {
                    console.error('Error parsing user info:', error);
                }
            } else {
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isLocal) {
                    const demoUser = { name: 'Demo User', email: 'demo@localhost', id: 'demo' };
                    sessionStorage.setItem('userInfo', JSON.stringify(demoUser));
                    document.getElementById('userProfile').style.display = 'flex';
                    document.getElementById('userName').textContent = demoUser.name;
                    document.getElementById('userEmail').textContent = demoUser.email;
                    document.getElementById('userAvatar').textContent = 'DU';
                } else {
                    window.location.replace('/login.html');
                }
            }
        }

        function logout() {
            sessionStorage.clear();
            localStorage.clear();
            window.location.replace('/login.html');
        }

        // Go to home/reload page
        function goHome() {
            window.location.reload();
        }

        // Subscription Management
        function changeSubscription() {
            const select = document.getElementById('subscriptionSelect');
            const selectedOption = select.options[select.selectedIndex];
            const subscriptionName = selectedOption.text;
            
            // Update insights based on subscription
            updateInsightsForSubscription(select.value);
            
            // Show notification
            showNotification(`Switched to ${subscriptionName} context`);
            
            // Clear conversation history when switching context
            conversationHistory = [];
            
            // Inform user about context switch
            const chatContainer = document.getElementById('chatContainer');
            if (!document.querySelector('.welcome-state')) {
                const contextMessage = document.createElement('div');
                contextMessage.className = 'context-switch-message';
                contextMessage.innerHTML = `
                    <div style="background: var(--surface-light); border: 1px solid var(--primary); border-radius: 12px; padding: 16px; margin: 16px auto; max-width: 600px; text-align: center;">
                        <strong style="color: var(--primary);">üìå Subscription Context Changed</strong><br>
                        <span style="color: var(--text-secondary); font-size: 13px;">Now showing data for: ${subscriptionName}</span>
                    </div>
                `;
                chatContainer.appendChild(contextMessage);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function updateInsightsForSubscription(subscriptionId) {
            // Simulate different data for different subscriptions
            const subscriptionData = {
                'all': {
                    health: '89%',
                    cost: '$5,890',
                    resources: '234',
                    security: '82/100',
                    optimization: '$1,450',
                    performance: '96.2%'
                },
                'sub1': {
                    health: '92%',
                    cost: '$2,450',
                    resources: '87',
                    security: '85/100',
                    optimization: '$890',
                    performance: '98.7%'
                },
                'sub2': {
                    health: '88%',
                    cost: '$1,890',
                    resources: '65',
                    security: '80/100',
                    optimization: '$420',
                    performance: '95.3%'
                },
                'sub3': {
                    health: '85%',
                    cost: '$1,550',
                    resources: '82',
                    security: '78/100',
                    optimization: '$310',
                    performance: '94.1%'
                }
            };

            const data = subscriptionData[subscriptionId] || subscriptionData['sub1'];

            // Update header stats
            document.querySelector('.header-stat.success .header-stat-value').textContent = data.health;
            document.querySelector('.header-stat.warning .header-stat-value').textContent = data.cost;
            document.querySelectorAll('.header-stat')[2].querySelector('.header-stat-value').textContent = data.resources;

            // Update sidebar insights
            document.querySelector('.insight-card.success .insight-value').textContent = data.security;
            document.querySelector('.insight-card.warning .insight-value').textContent = data.optimization;
            document.querySelectorAll('.insight-card.success')[1].querySelector('.insight-value').textContent = data.performance;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                background: var(--primary);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Category Management
        function toggleCategory(categoryId) {
            const header = event.currentTarget;
            const prompts = document.getElementById(`category-${categoryId}`);
            
            header.classList.toggle('active');
            prompts.classList.toggle('active');
        }

        function showCategory(categoryId) {
            // Scroll to sidebar and open category
            const categoryHeader = document.querySelector(`#category-${categoryId}`).previousElementSibling;
            if (!categoryHeader.classList.contains('active')) {
                categoryHeader.click();
            }
            
            // Remove welcome state
            const welcomeState = document.querySelector('.welcome-state');
            if (welcomeState) {
                welcomeState.remove();
            }
        }

        function quickPrompt(prompt) {
            const welcomeState = document.querySelector('.welcome-state');
            if (welcomeState) {
                welcomeState.remove();
            }
            
            document.getElementById('userInput').value = prompt;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            const welcomeState = document.querySelector('.welcome-state');
            if (welcomeState) {
                welcomeState.remove();
            }

            addMessage(message, 'user');
            input.value = '';
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('sendBtn').textContent = 'Thinking...';

            try {
                const userInfo = sessionStorage.getItem('userInfo');
                const user = userInfo ? JSON.parse(userInfo) : null;
                const accessToken = sessionStorage.getItem('accessToken');

                const headers = { 'Content-Type': 'application/json' };
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }

                // Get current subscription context
                const subscriptionSelect = document.getElementById('subscriptionSelect');
                const selectedSubscription = subscriptionSelect.value;
                const subscriptionName = subscriptionSelect.options[subscriptionSelect.selectedIndex].text;
                
                // Check if user is asking for all subscriptions in their prompt
                const askingForAll = message.toLowerCase().includes('all subscription') || 
                                    message.toLowerCase().includes('across all') ||
                                    message.toLowerCase().includes('every subscription');
                
                // Determine actual context to use
                const contextToUse = askingForAll ? 'all' : selectedSubscription;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory,
                        user_email: user?.email,
                        user_name: user?.name,
                        subscription_context: contextToUse,
                        subscription_name: subscriptionName,
                        prompt_override_context: askingForAll
                    })
                });

                const data = await response.json();
                addMessage(data.response, 'assistant');
                conversationHistory = data.conversation_history || [];

            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('sendBtn').textContent = 'Send ‚úàÔ∏è';
                input.focus();
            }
        }

        function addMessage(text, role) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? document.getElementById('userAvatar').textContent : 'ü§ñ';

            const content = document.createElement('div');
            content.className = 'message-content';
            
            // Convert markdown to HTML with proper table rendering
            let formattedText = text;
            
            // Convert markdown tables to HTML tables
            formattedText = convertMarkdownTablesToHTML(formattedText);
            
            // Convert bold markdown
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert line breaks (only if not already in HTML table)
            if (!formattedText.includes('<table>')) {
                formattedText = formattedText.replace(/\n/g, '<br>');
            }
            
            content.innerHTML = formattedText;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function convertMarkdownTablesToHTML(text) {
            const lines = text.split('\n');
            let inTable = false;
            let tableHTML = '';
            let result = '';
            let headers = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Check if line is a table row
                if (line.startsWith('|') && line.endsWith('|')) {
                    // Skip separator lines (containing ---)
                    if (line.includes('---')) {
                        continue;
                    }
                    
                    const cells = line.split('|').filter(cell => cell.trim()).map(cell => cell.trim());
                    
                    if (!inTable) {
                        // Start new table
                        inTable = true;
                        headers = cells;
                        tableHTML = '<div class="table-wrapper"><table><thead><tr>';
                        cells.forEach(cell => {
                            tableHTML += `<th>${cell}</th>`;
                        });
                        tableHTML += '</tr></thead><tbody>';
                    } else {
                        // Add data row
                        tableHTML += '<tr>';
                        cells.forEach((cell, index) => {
                            // Highlight certain values
                            let cellContent = cell;
                            
                            // Check for cost/savings values
                            if (cell.match(/\$[\d,]+/) || cell.includes('USD')) {
                                cellContent = `<span class="cost-highlight">${cell}</span>`;
                            }
                            // Check for percentages
                            else if (cell.match(/\d+(\.\d+)?%/)) {
                                const percentage = parseFloat(cell);
                                if (percentage < 0) {
                                    cellContent = `<span class="savings-highlight">${cell}</span>`;
                                } else if (percentage > 80) {
                                    cellContent = `<span class="danger-highlight">${cell}</span>`;
                                }
                            }
                            // Check for status words
                            else if (cell.toLowerCase().includes('critical') || cell.toLowerCase().includes('high') || cell.toLowerCase().includes('danger')) {
                                cellContent = `<span class="danger-highlight">${cell}</span>`;
                            }
                            else if (cell.toLowerCase().includes('success') || cell.toLowerCase().includes('healthy') || cell.toLowerCase().includes('operational')) {
                                cellContent = `<span class="savings-highlight">${cell}</span>`;
                            }
                            else if (cell.toLowerCase().includes('warning') || cell.toLowerCase().includes('medium')) {
                                cellContent = `<span class="cost-highlight">${cell}</span>`;
                            }
                            
                            tableHTML += `<td>${cellContent}</td>`;
                        });
                        tableHTML += '</tr>';
                    }
                } else {
                    // Not a table line
                    if (inTable) {
                        // Close the table
                        tableHTML += '</tbody></table></div>';
                        result += tableHTML + '\n';
                        tableHTML = '';
                        inTable = false;
                        headers = [];
                    }
                    
                    // Add regular line
                    if (line) {
                        result += line + '\n';
                    }
                }
            }
            
            // Close table if still open
            if (inTable) {
                tableHTML += '</tbody></table></div>';
                result += tableHTML;
            }
            
            return result;
        }

        // Event listeners
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Load Azure Subscriptions
        async function loadAzureSubscriptions() {
            try {
                const accessToken = sessionStorage.getItem('accessToken');
                const headers = { 'Content-Type': 'application/json' };
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }

                // Call backend to get subscriptions
                const response = await fetch('/api/subscriptions', {
                    method: 'GET',
                    headers: headers
                });

                if (response.ok) {
                    const subscriptions = await response.json();
                    const select = document.getElementById('subscriptionSelect');
                    
                    // Clear loading option
                    select.innerHTML = '<option value="all">All Subscriptions</option>';
                    
                    // Add real subscriptions
                    if (subscriptions && subscriptions.length > 0) {
                        subscriptions.forEach((sub, index) => {
                            const option = document.createElement('option');
                            option.value = sub.id || sub.subscriptionId;
                            option.textContent = sub.displayName || sub.name;
                            if (index === 0) option.selected = true; // Select first subscription by default
                            select.appendChild(option);
                        });
                        
                        // Store subscriptions in session for later use
                        sessionStorage.setItem('azureSubscriptions', JSON.stringify(subscriptions));
                        
                        // Update insights for first subscription
                        if (subscriptions.length > 0) {
                            updateInsightsForSubscription(subscriptions[0].id || subscriptions[0].subscriptionId);
                        }
                    } else {
                        // No subscriptions found
                        select.innerHTML = '<option value="none">No subscriptions available</option>';
                    }
                } else {
                    console.error('Failed to load subscriptions');
                    const select = document.getElementById('subscriptionSelect');
                    select.innerHTML = '<option value="current">Current Subscription</option>';
                }
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                const select = document.getElementById('subscriptionSelect');
                select.innerHTML = '<option value="current">Current Subscription</option>';
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            loadUserProfile();
            loadAzureSubscriptions();
            document.getElementById('userInput').focus();
        });
    </script>
</body>
</html>
